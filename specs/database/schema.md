# Database Schema

## Overview

Neon Serverless PostgreSQL database with tables for user authentication (managed by Better Auth) and application data (tasks).

## Database Configuration

| Setting | Value |
|---------|-------|
| Provider | Neon Serverless PostgreSQL |
| ORM | SQLModel (SQLAlchemy + Pydantic) |
| Connection | Pooled via `DATABASE_URL` |

## Entity Relationship Diagram

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        DATABASE SCHEMA                                   │
└─────────────────────────────────────────────────────────────────────────┘

  ┌─────────────────┐           ┌─────────────────┐
  │      user       │           │     session     │
  │─────────────────│           │─────────────────│
  │ id (PK)         │◄──────────│ user_id (FK)    │
  │ email           │     1:N   │ id (PK)         │
  │ name            │           │ expires_at      │
  │ email_verified  │           │ created_at      │
  │ image           │           └─────────────────┘
  │ created_at      │
  │ updated_at      │           ┌─────────────────┐
  └────────┬────────┘           │    account      │
           │                    │─────────────────│
           │              1:N   │ user_id (FK)    │
           ├────────────────────│ id (PK)         │
           │                    │ provider        │
           │                    │ provider_id     │
           │                    └─────────────────┘
           │
           │              1:N   ┌─────────────────┐
           └────────────────────│     tasks       │
                                │─────────────────│
                                │ id (PK)         │
                                │ user_id (FK)    │
                                │ title           │
                                │ description     │
                                │ completed       │
                                │ created_at      │
                                │ updated_at      │
                                └─────────────────┘
```

## Tables

### user (Better Auth Managed)

User accounts created by Better Auth.

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | VARCHAR(36) | PRIMARY KEY | UUID generated by Better Auth |
| email | VARCHAR(255) | UNIQUE, NOT NULL | User email address |
| name | VARCHAR(255) | | Display name |
| email_verified | BOOLEAN | DEFAULT FALSE | Email verification status |
| image | TEXT | | Profile image URL |
| created_at | TIMESTAMP | DEFAULT NOW() | Account creation time |
| updated_at | TIMESTAMP | DEFAULT NOW() | Last update time |

### session (Better Auth Managed)

Active user sessions.

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | VARCHAR(36) | PRIMARY KEY | Session ID |
| user_id | VARCHAR(36) | FK -> user.id | Session owner |
| expires_at | TIMESTAMP | NOT NULL | Session expiry |
| created_at | TIMESTAMP | DEFAULT NOW() | Session start |
| ip_address | VARCHAR(45) | | Client IP |
| user_agent | TEXT | | Browser info |

### account (Better Auth Managed)

OAuth provider accounts (for future social login).

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | VARCHAR(36) | PRIMARY KEY | Account ID |
| user_id | VARCHAR(36) | FK -> user.id | Account owner |
| provider | VARCHAR(50) | NOT NULL | OAuth provider name |
| provider_account_id | VARCHAR(255) | NOT NULL | ID from provider |
| access_token | TEXT | | OAuth access token |
| refresh_token | TEXT | | OAuth refresh token |
| expires_at | TIMESTAMP | | Token expiry |

### tasks (Application Managed)

User todo items.

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | SERIAL | PRIMARY KEY | Auto-incrementing ID |
| user_id | VARCHAR(36) | FK -> user.id, NOT NULL | Task owner |
| title | VARCHAR(200) | NOT NULL | Task title |
| description | TEXT | | Task description |
| completed | BOOLEAN | DEFAULT FALSE | Completion status |
| created_at | TIMESTAMP | DEFAULT NOW() | Creation time |
| updated_at | TIMESTAMP | DEFAULT NOW() | Last update time |

## Indexes

```sql
-- Tasks table indexes
CREATE INDEX idx_tasks_user_id ON tasks(user_id);
CREATE INDEX idx_tasks_completed ON tasks(completed);
CREATE INDEX idx_tasks_user_completed ON tasks(user_id, completed);
CREATE INDEX idx_tasks_created_at ON tasks(created_at DESC);

-- Session table indexes (Better Auth creates these)
CREATE INDEX idx_session_user_id ON session(user_id);
CREATE INDEX idx_session_expires ON session(expires_at);
```

## SQLModel Definition

```python
# models.py
from sqlmodel import SQLModel, Field
from datetime import datetime

class Task(SQLModel, table=True):
    __tablename__ = "tasks"

    id: int | None = Field(default=None, primary_key=True)
    user_id: str = Field(foreign_key="user.id", index=True)
    title: str = Field(max_length=200)
    description: str | None = Field(default=None)
    completed: bool = Field(default=False, index=True)
    created_at: datetime = Field(default_factory=datetime.utcnow)
    updated_at: datetime = Field(default_factory=datetime.utcnow)
```

## Database Connection

```python
# db.py
from sqlmodel import SQLModel, create_engine, Session
import os

DATABASE_URL = os.environ["DATABASE_URL"]

# Neon requires sslmode
engine = create_engine(
    DATABASE_URL,
    echo=True,  # Set False in production
    pool_pre_ping=True,
)

def get_session():
    with Session(engine) as session:
        yield session

def create_db_and_tables():
    SQLModel.metadata.create_all(engine)
```

## Migrations

For production, use Alembic for migrations:

```bash
# Initialize Alembic
alembic init alembic

# Generate migration
alembic revision --autogenerate -m "Add tasks table"

# Apply migrations
alembic upgrade head
```

### Initial Migration

```python
# alembic/versions/001_create_tasks.py
def upgrade():
    op.create_table(
        'tasks',
        sa.Column('id', sa.Integer(), primary_key=True),
        sa.Column('user_id', sa.String(36), sa.ForeignKey('user.id'), nullable=False),
        sa.Column('title', sa.String(200), nullable=False),
        sa.Column('description', sa.Text()),
        sa.Column('completed', sa.Boolean(), default=False),
        sa.Column('created_at', sa.DateTime(), default=datetime.utcnow),
        sa.Column('updated_at', sa.DateTime(), default=datetime.utcnow),
    )
    op.create_index('idx_tasks_user_id', 'tasks', ['user_id'])
    op.create_index('idx_tasks_completed', 'tasks', ['completed'])

def downgrade():
    op.drop_table('tasks')
```

## Query Patterns

### Get User's Tasks

```python
def get_user_tasks(
    session: Session,
    user_id: str,
    status: str = "all"
) -> list[Task]:
    query = select(Task).where(Task.user_id == user_id)

    if status == "pending":
        query = query.where(Task.completed == False)
    elif status == "completed":
        query = query.where(Task.completed == True)

    query = query.order_by(Task.created_at.desc())

    return session.exec(query).all()
```

### Create Task

```python
def create_task(
    session: Session,
    user_id: str,
    title: str,
    description: str | None = None
) -> Task:
    task = Task(
        user_id=user_id,
        title=title,
        description=description
    )
    session.add(task)
    session.commit()
    session.refresh(task)
    return task
```

### Update Task

```python
def update_task(
    session: Session,
    task_id: int,
    user_id: str,
    **updates
) -> Task | None:
    task = session.exec(
        select(Task)
        .where(Task.id == task_id, Task.user_id == user_id)
    ).first()

    if not task:
        return None

    for key, value in updates.items():
        if value is not None:
            setattr(task, key, value)

    task.updated_at = datetime.utcnow()
    session.commit()
    session.refresh(task)
    return task
```

## Data Integrity

### Constraints

| Constraint | Table | Description |
|------------|-------|-------------|
| FK user_id | tasks | References user.id, ON DELETE CASCADE |
| NOT NULL | tasks.title | Title is required |
| CHECK | tasks.title | Length between 1-200 |

### Cascading Deletes

When a user is deleted, their tasks are also deleted:

```sql
ALTER TABLE tasks
ADD CONSTRAINT fk_tasks_user
FOREIGN KEY (user_id) REFERENCES "user"(id)
ON DELETE CASCADE;
```

## Related Specifications

- [REST API Endpoints](../api/rest-endpoints.md)
- [Authentication](../features/003-authentication.md)
- [System Architecture](../architecture.md)
